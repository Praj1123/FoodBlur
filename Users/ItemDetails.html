<!doctype html>
<html lang="en">
<title>Details</title>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="stylesheet" href="productDetails.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>

<body>
    <div class="color1 pb-5" style="width: 100%;height: 100%;">
        <nav class="navbar color2">
            <div class="color2" style="text-align: left;float: left;padding-left: 10px;">
                <a class="navbar-brand" href="#">
                    <img src="/images/BrandLogo.png" alt="Logo" width="140" height="45"
                        class="d-inline-block align-text-top">
                </a>
            </div>
        </nav>

        <div class="container m-5" id="placeholder2">
            <div class="card shadow-lg">
                <div class="container-fliud">
                    <div class="wrapper row">
                        <div class="preview col-md-6">
                            <div class="preview-pic tab-content placeholder-wave">
                                <div class="tab-pane active" id="pic-1" style="height:400px"><img
                                        src="/images/soildBackground.png" class=""></div>
                            </div>
                        </div>
                        <div class="details col-md-6">
                            <div>
                                <h3 class="product-title">
                                    <p class="placeholder-wave" style="color:#4d7c0f">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </h3>
                                <div class="rating">
                                    <div class="stars">
                                        <span class="fa fa-star checked"></span>
                                        <span class="fa fa-star checked"></span>
                                        <span class="fa fa-star checked"></span>
                                        <span class="fa fa-star"></span>
                                        <span class="fa fa-star"></span>
                                    </div>
                                </div>
                                <p class="product-description" style="font-size: 15px;">
                                <p class="placeholder-wave" style="color:#4d7c0f">
                                    <span class="placeholder col-5"></span>
                                </p>
                                </p>
                                <p class="vote"><strong>
                                        <p class="placeholder-wave" style="color:#4d7c0f">
                                            <span class="placeholder col-3"></span>
                                        </p>
                                </p>
                                <h5 class="sizes">
                                    <p class="placeholder-wave" style="color:#4d7c0f">
                                        <span class="placeholder col-7"></span>
                                    </p>
                                    <p class="placeholder-wave" style="color:#4d7c0f">
                                        <span class="placeholder col-7"></span>
                                    </p>
                                </h5>
                                <div class="mt-5">
                                    <h2>
                                        <p class="placeholder-wave" style="color:#4d7c0f">
                                            <span class="placeholder col-8"></span>
                                        </p>
                                    </h2>
                                </div>
                            </div>
                            <div class="action">
                                <h1>
                                    <p class="placeholder-glow" style="color:#4d7c0f">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container m-5" style="display: none;" id="container2">
            <div class="card shadow-lg" id="render2">
                <!--render here-->
            </div>
        </div>

        <div class="container mb-5">
            <div class="row">
                <div class="col-sm-6 mb-3 mb-sm-0" id="placeholder3">
                    <div class="card shadow-lg">
                        <div class="card-body" style="height: 400px;overflow-y: scroll;">
                            <h5 class="card-title fs-5" style="color: #4d7c0f;">
                                <p class="placeholder-wave" style="color:#4d7c0f">
                                    <span class="placeholder col-4"></span>
                                </p>
                            </h5>
                            <p style="text-indent: 50px; letter-spacing: 1px;" class="fw-semibold">
                            <p class="placeholder-glow" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-wave" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-wave" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-wave" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-glow" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-wave" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-wave" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>
                            <p class="placeholder-glow" style="color:#4d7c0f">
                                <span class="placeholder col-12"></span>
                            </p>

                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6 mb-3 mb-sm-0" id="render3" style="display: none;">
                    <!---Render here-->
                </div>

                <div class="col-sm-6">
                    <div class="card shadow-lg">
                        <div class="card-body"
                            style="height: 400px;overflow-y: scroll;overflow-x: scroll;scrollbar-width:thin;">
                            <h5 class="card-title" style="color: #4d7c0f;">Menu</h5>
                            <p class="card-text p-0">
                            <table class="table">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Days</th>
                                        <th scope="col">Item1</th>
                                        <th scope="col">Item2</th>
                                        <th scope="col">Item3</th>
                                        <th scope="col">Item4</th>
                                        <th scope="col">Additional</th>
                                    </tr>
                                </thead>
                                <tbody class="table-group-divider table-border">
                                    <tr>
                                        <th scope="row">Sunday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Monday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Tuesday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Wednesday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Thursday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Friday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Saturday</th>
                                        <td>Chapati</td>
                                        <td>Dal</td>
                                        <td>Gira Rice</td>
                                        <td>Aanda kari</td>
                                        <td>Salad</td>
                                    </tr>
                                </tbody>
                            </table>
                            </p>
                        </div>
                    </div>
                </div>

                
            </div>
        </div>
    </div>
    <div class="offcanvas offcanvas-top" tabindex="-1" id="offcanvasTop" aria-labelledby="offcanvasTopLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasTopLabel">Status : <b style="color:red;">Offline</b></h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <img src="NoInternetConnectionIcon.png"
                style="display:block;margin: 0 auto;width: 100px;height: 100px;color: aliceblue;">
        </div>
    </div>

    <div class="card m-5">
        <h5 class="card-header" style="color: #4d7c0f;">Request a Break from Delivery<span class="text-warning"
                style="float: inline-end;display:inline;" id="alert_text"><u>This option is enable once
                    you buy the subscription</u>
            </span></h5>
        <div class="card-body">
            <h5 class="card-title">Note:</h5>
            <ul class="text-warning" style="font-weight: 500;">
                <li>Request should be made atleast 1 day before the break</li>
                <li>Break should be greater then atleast three continous day</li>
            </ul>
            <div class="container text-center">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="col-3 input-group flex-nowrap m-2">
                            <span class="input-group-text" id="addon-wrapping">Starting date</span>
                            <input type="date" class="form-control" placeholder="Username" aria-label="Username"
                                aria-describedby="addon-wrapping" id="starting_date">
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="col-3 input-group flex-nowrap m-2">
                            <span class="input-group-text" id="addon-wrapping">Ending date</span>
                            <input type="date" class="form-control" placeholder="Username" aria-label="Username"
                                aria-describedby="addon-wrapping" id="ending_date">
                        </div>
                    </div>
                </div>
            </div>

            <p class="card-text">Wanring: No money will be deduct from the subscription only equivalent amount will be
                substract when you buy next subscription of same vendor</p>
            <button class="btn btn-outline-primary" id="proceed" disabled>Send Request</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyChtcoj-0g8LcHXW26Tyqkm_7Xxj8jG5Ow",
            authDomain: "food-blur.firebaseapp.com",
            projectId: "food-blur",
            storageBucket: "food-blur.appspot.com",
            messagingSenderId: "911842353467",
            appId: "1:911842353467:web:3107951f8434294e96571e",
            measurementId: "G-9WG8FE55NE"
        };

        firebase.initializeApp(firebaseConfig);
        const dataRef = firebase.firestore();
        const storage = firebase.storage();
        var data;
        var half_price = ''
        var full_price = ''
        console.log(sessionStorage.getItem('cardId'))
        dataRef.collection("vendors").doc(sessionStorage.getItem('cardId')).get().then((doc) => {
            data = doc.data();
            half_price = data.half_taffin
            full_price = data.full_taffin
            document.getElementById("placeholder2").style.display = "none"
            document.getElementById("container2").style.display = "block"
            document.getElementById("render2").innerHTML =
                `<div class="container-fliud">
                    <div class="wrapper row">
                        <div class="preview col-md-6">
                            <div class="preview-pic tab-content placeholder-wave">
                                <div class="tab-pane active" id="pic-1" style="height:400px"><img
                                        src=${data.ItemURL} class=""></div>
                            </div>
                        </div>
                        <div class="details col-md-6">
                          <div>
                            <h3 class="product-title pl-3 pt-3" style='color:#4d7c0f'>${data.Title}</h3>
                            <div class="rating">
                                <div class="stars">
                                    <span class="fa fa-star checked"></span>
                                    <span class="fa fa-star checked"></span>
                                    <span class="fa fa-star checked"></span>
                                    <span class="fa fa-star"></span>
                                    <span class="fa fa-star"></span>
                                </div>
                            </div>
                            <p class="product-description" style="font-size: 15px;">Home made vegetarian Taffin
                            </p>
                            <p class="vote"><strong>Free Delivery</p>
                            <h5 class="sizes">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="flexRadioDefault"
                                        id="radio1" onclick="radioBtn()">
                                    <label class="form-check-label" for="flexRadioDefault1">
                                        Full Taffin
                                    </label> 
                                </div>
                                <div class="col-md-4">
                                <div class="form-check ">
                                    <input class="form-check-input" type="radio" name="flexRadioDefault"
                                        id="radio2" onclick="radioBtn()" checked>
                                    <label class="form-check-label" for="flexRadioDefault2">
                                        Half Taffin
                                    </label>
                                    <select class="form-select mt-3 w-2" aria-label="Default select example" id='shift' onchange="radioBtn()">
                                      <option value="Afternoon" selected>Afternoon</option>
                                      <option value="Night">Night</option>
                                    </select>
                                </div>
                                </div>
                            </h5>
                            <div class="mt-3" style="mardin-bottom:0%">
                                <h2 class="price">
                                     <span style="color:#4d7c0f" id="price2Lable">₹ ${data.half_taffin}-/Month</span>
                                     </h2>
                                     <h2 class="price">
                                     <span style="color:#4d7c0f;display:none" id="price1Lable">₹ ${data.full_taffin}-/Month</span>
                                </h2>
                                <p class='text-success' style='display:none;font-weight:500;line-height:1' id='discount_text'>You will get flat ₹<span id='price'>---</span> off on next purchase on account of your <span id='lives'>7</span> days break</p>
                            </div>
                           </div> 
                           <div class="action">
                    <button type="button" class="btn btn-lg mt-1"
                        style="background-color: #4d7c0f;color: white;" onclick="buyNow()" id='buy_btn'><b>Buy 1 Month
                         Subscription</b></button>
                </div>
                        </div>
                    </div>
                </div>`

            localStorage.setItem("itemPrice", data.half_taffin)
            localStorage.setItem("itemTitle", data.Title);
            localStorage.setItem('shift', 'Afternoon')
            localStorage.setItem('Qualtity', 'Half Taffin')

            document.getElementById("placeholder3").style.display = "none"
            document.getElementById("render3").style.display = "inline-block"
            document.getElementById("render3").innerHTML =
                `<div class="card shadow-lg">
                        <div class="card-body" style="height: 400px;overflow-y: scroll;">
                            <h5 class="card-title fs-5" style="color: #4d7c0f;">Description</h5>
                            <p style="text-indent: 50px; letter-spacing: 1px;" class="fw-semibold">${data.Description}</p>
                        </div>
                    </div>`
        })

        set_state_of_buy_btn()
        function set_state_of_buy_btn() {
            var card_id = sessionStorage.getItem('cardId')
            try {
                dataRef.collection("users").doc(localStorage.getItem('userDataId')).collection('orders').get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            var data = doc.data();
                            var vendor_data_id = data.vendor_data_id
                            if (vendor_data_id == card_id) {
                                console.log('Already buy')
                                document.getElementById('buy_btn').setAttribute("disabled", "true")
                                document.getElementById('buy_btn').innerHTML = 'Already Buy'
                                document.getElementById('alert_text').style.display = 'none'
                                document.getElementById('proceed').removeAttribute('disabled');
                                if (data['requested_day']) {
                                    document.getElementById('discount_text').style.display = 'block'
                                    var diff = data['requested_day']
                                    document.getElementById('lives').innerHTML = data['requested_day']
                                    price = full_price
                                    half_price = half_price - Math.ceil(half_price / data['requested_day'])
                                    full_price = full_price - Math.ceil(full_price / data['requested_day'])
                                    data.half_taffin = half_price
                                    data.full_taffin = full_price
                                    console.log(data.full_taffin)
                                    document.getElementById('price2Lable').innerHTML = "₹" + half_price + " " + "/-Month"
                                    document.getElementById('price1Lable').innerHTML = "₹" + full_price + " " + "/-Month"
                                    document.getElementById('price').innerHTML = Math.ceil(price / data['requested_day'])
                                }
                            }
                        });
                    })
                    .catch((error) => {
                        console.log("Error getting documents: ", error);
                    });
            } catch (error) {
                console.log(error)
                alert('Something went wrong')
            }


        }
        function radioBtn() {
            var radio1 = document.getElementById("radio1");
            var radio2 = document.getElementById("radio2");
            var price1Lable = document.getElementById("price1Lable");
            var price2Lable = document.getElementById("price2Lable");
            var shift = document.getElementById('shift')
            console.log(shift.value)

            if (radio1.checked == true) {
                price1Lable.style.display = "inline-block";
                price2Lable.style.display = "none";
                shift.style.display = 'none'
                localStorage.setItem("itemPrice", data.full_taffin)
                localStorage.setItem('Qualtity', 'full Taffin')
                localStorage.setItem('shift', 'both')
            } else {
                if (radio2.checked == true) {
                    price1Lable.style.display = "none";
                    price2Lable.style.display = "inline-block";
                    shift.style.display = 'block'
                    localStorage.setItem("itemPrice", data.half_taffin)
                    localStorage.setItem('shift', shift.value)
                    localStorage.setItem('Qualtity', 'Half Taffin')
                }
            }

        }

        function showNotInternetToggle() {
            const myOffcanvas = document.getElementById('offcanvasTop')
            const bsOffcanvas = new bootstrap.Offcanvas(myOffcanvas)
            return bsOffcanvas.show()
        }

        setInterval(() => {
            if (window.navigator.onLine == true) {
                showNotInternethide()
                console.log("Online")
            } else {
                showNotInternetToggle()
                console.log("Offline")
            }
        }, 10000)

        function buyNow() {
            console.log("--------")
            if (localStorage.getItem("userDataId") == null) {
                alert("You need to sign in first")
                window.location.replace("home.html")
            } else {
                window.location.href = "standard.html"
            }
        }
        function dateDiffInDays(date1, date2) {
            const [year1, month1, day1] = date1.split('-');
            const [year2, month2, day2] = date2.split('-');

            const dt1 = new Date(`20${year1}-${month1}-${day1}`);
            const dt2 = new Date(`20${year2}-${month2}-${day2}`);

            const diffInMilliseconds = Math.abs(dt2 - dt1);
            const diffInDays = diffInMilliseconds / (1000 * 60 * 60 * 24);
            return Math.floor(diffInDays);
        }


        count1 = 0
        count2 = 0

        function requested_date() {
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            const formattedDate = `${year}-${month}-${day}`;
            return formattedDate
        }

        function generateDataId() {
            const randomString = CryptoJS.lib.WordArray.random(6).toString(CryptoJS.enc.Hex);
            const dataId = randomString.padStart(12, '0');
            return dataId;
        }

        document.getElementById('proceed').addEventListener('click', () => {
            console.log(count1, count2)
            if (count1 == 1 && count2 == 1) {
                var starting_date = document.getElementById('starting_date').value
                var ending_date = document.getElementById('ending_date').value
                var diff = dateDiffInDays(starting_date, ending_date)
                var document_id = generateDataId()
                var date_of_request = requested_date()
                const data = dataRef.collection('vendors').doc(sessionStorage.getItem('cardId')).collection('Notification').doc(document_id).set({
                    starting_date: starting_date,
                    ending_date: ending_date,
                    diff: diff,
                    status: 'Pending',
                    userDataId: localStorage.getItem('userDataId'),
                    user_doc_id: sessionStorage.getItem('user_docId'),
                    vendor_doc_id: sessionStorage.getItem('vendor_docId'),
                    date_of_request: date_of_request
                }).then(() => {
                    console.log(data.id)
                    console.log('Request set in vendor database')
                    dataRef.collection('users').doc(localStorage.getItem('userDataId')).collection('Requests').doc(document_id).set({
                        starting_date: starting_date,
                        ending_date: ending_date,
                        diff: diff,
                        status: 'Pending',
                        vendor_data_id: sessionStorage.getItem('cardId'),
                        date_of_request: date_of_request
                    }).then(() => {
                        alert('Your request send successfully')
                        window.location.href = 'requests.html'
                        console.log('Request send in user database')
                    })

                }).catch((error) => {
                    alert("We have some  problem while placing the order")
                    console.log(error);
                })

            } else {
                alert('Invalid Request, Please Recheck the date')
            }
        })

        document.getElementById('starting_date').addEventListener('change', () => {
            var starting_date = document.getElementById('starting_date').value
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            const formattedDate = `${year}-${month}-${day}`;
            if (starting_date == formattedDate) {
                alert('Request made 1 day before the break')
            } else {
                if (starting_date < formattedDate) {
                    alert('You cannot made request of using date of previous days')
                } else {
                    count1 = 1
                }
            }
        })


        document.getElementById('ending_date').addEventListener('change', () => {
            var ending_date = document.getElementById('ending_date').value
            var starting_date = document.getElementById('starting_date').value
            days = dateDiffInDays(starting_date, ending_date)
            console.log(days)
            if (days <= 3) {
                if (confirm("Your days will not append to the last date of subscription expiray as it is less 3 days. Atleast 3 or more than 3 continous days required to avail this facility. Still you can proceed.")) {
                    count2 = 1
                } else {
                    count2 = 1
                }
            } else {
                count2 = 1
            }
        })

        if (sessionStorage.getItem('user_docId')) {
            document.getElementById('alert_text').style.display = 'none'
            document.getElementById('proceed').removeAttribute('disabled') = false

        }

    </script>
</body>

</html>